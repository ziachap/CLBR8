{% extends "App/base.html" %}
{% load staticfiles %}
{% block title %}Browse Projects{% endblock %}
{% block find_projects_active %}active{% endblock %}
{% block head %}
    <!-- Google Maps API -->
    <style type="text/css">
      #map-canvas { width: 100%; min-height: 400px; height: 100%; margin: 0; padding: 0;}
      #map-canvas-full {
        position:fixed;
        padding:0;
        margin:0;
        top:0;
        left:0;
        bottom:0;
        width: 100%;
        min-height: 800px;
        height: 100%;
        overflow:hidden;
        z-index: 6;
      }
      .info_content {
        width: 340px;
        overflow-x: hidden;
        overflow-y: auto;
      }
      .info_icons {
        margin-top: -15px;
        margin-bottom: 4px;
        margin-left: -2px;
      }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCJ_kAww6tmQVER8PQtFicAZ7JdjekbnU"></script>
    <script type="text/javascript">
      function initialize() {
        // Setup map
        var mapOptions = {
          center: { lat: 51.5072, lng: -0.1275},
          zoom: 12,
          disableDefaultUI: true,
          streetViewControl: false,
          streetViewControlOptions: {
            position: google.maps.ControlPosition.LEFT_CENTER
          },
          zoomControl: true,
          zoomControlOptions: {
            position: google.maps.ControlPosition.LEFT_CENTER
          }
        };
        var map = new google.maps.Map(document.getElementById('map-canvas-full'),
            mapOptions);

        // Populate markers with location data
        var markers = [
            {% for project in project_list %}
                ['{{ project.title }}', {{ project.latitude }},{{ project.longitude }}],
            {% endfor %}
        //['Home', 51.507408,-0.277812],
        //['Palace of Westminster, London', 51.499633,-0.124755]
        ];

        // Populate marker info windows with listing dat
        var infoWindowContent = [
            {% for project in project_list %}
            ['<div class="info_content">' +
            '<div class="row"><div class="col-md-10"><h3>{{ project.title }}</h3></div></div>' +
            '<div class="row">' +
                '<div class="col-md-2">' +
                    '<img class="img-rounded custom-img-rounded" src="{% static 'images/blank_user.jpg' %}" width="50" height="50">' +
                '</div>' +
                '<div class="col-md-6 info_icons">' +
                    '<h3><small><p><i class="fa fa-user fa-fw"></i> <a href="/profile/{{ project.owner.username }}">{{ project.owner.profile.artist_name }}</a></p> ' +
                    '<p><i class="fa fa-gbp fa-fw"></i>{% if project.price == 0 %}No Payment{% else %}{{ project.price }}{% endif %}</p></small></h3>' +
                '</div>' +
            '</div>' +
            '<p>{{ project.description|truncatewords:20 }}</p>' +
            //'<p><button class="btn btn-default btn-sm" onclick="wavesurfer{{ forloop.counter0 }}.playPause();"><i class="fa fa-play fa-fw"></i></button></button><div id="wave{{ forloop.counter0 }}"></div></p>' +
            '<div class="audiojs"><audio src="{{ project.audio_file.url }}" controls preload="none" /></div><br />' +
            '<CENTER><a href="/listing/{{ project.id }}"><button class="btn btn-default btn-sm"><i class="fa fa-search fa-fw"></i> More Info</button></a></CENTER>' +
            '</div>'],
            {% endfor %}
        ];

        // Display multiple markers on a map
        var infoWindow = new google.maps.InfoWindow(), marker, i;

        // Loop through array of markers & place each one on the map
        for( i = 0; i < markers.length; i++ ) {
            var position = new google.maps.LatLng(markers[i][1], markers[i][2]);

            marker = new google.maps.Marker({
                position: position,
                map: map,
                title: markers[i][0]
            });

            // Allow each marker to have an info window
            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infoWindow.setContent(infoWindowContent[i][0]);
                    infoWindow.open(map, marker);
                }
            })(marker, i));
        }

      }
      google.maps.event.addDomListener(window, 'load', initialize);

      window.onresize = function(event) {
        initialize()
      };

    </script>
{%  endblock %}

{% block pre_content %}
        <!-- GOOGLE MAP API --><div id="map-canvas-full" class="map_holder_inner"></div>
{% endblock %}
{% block content %}
    <br />
{% endblock %}
{% comment %}{% block content %}
    <div class="blank_page_content">
        <h1>Browse Projects
        <p><small>Get involved in projects near you</small></p></h1>

        <!-- GOOGLE MAP API-->
        <div class="map_holder_outer"><div id="map-canvas" class="map_holder_inner"></div></div>
    `
    </div>
{% endblock %}{% endcomment %}

{% block audio_init %}

    <!-- Create audio player for each project -->
    <script>
        var wavesurfer = new Array() ;
        {% for project in project_list %}
        var wavesurfer{{ forloop.counter0 }} = Object.create(WaveSurfer);
        wavesurfer{{ forloop.counter0 }}.init({
            container: document.querySelector('#wave{{ forloop.counter0 }}'),
            waveColor: 'pink',
            progressColor: 'violet'
        });
        wavesurfer{{ forloop.counter0 }}.load('{{ project.audio_file.url }}');
        {% endfor %}
    </script>
{% endblock %}
