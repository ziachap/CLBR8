{% extends "App/base.html" %}
{% load staticfiles %}
{% block title %}Browse Projects{% endblock %}

{% block head %}
    <!-- Google Maps API -->
    <style type="text/css">
      #map-canvas { width: 100%; height: 550px; margin: 0; padding: 0;}
    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCJ_kAww6tmQVER8PQtFicAZ7JdjekbnU">
    </script>
    <script type="text/javascript">
      function initialize() {
        // Setup map
        var mapOptions = {
          center: { lat: 51.5072, lng: -0.1275},
          zoom: 12
        };
        var map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);

        // Populate markers with location data
        var markers = [
            {% for project in project_list %}
                ['{{ project.title }}', {{ project.latitude }},{{ project.longitude }}],
            {% endfor %}
        //['Home', 51.507408,-0.277812],
        //['Palace of Westminster, London', 51.499633,-0.124755]
        ];

        // Populate marker info windows with listing dat
        var infoWindowContent = [
            {% for project in project_list %}
            ['<div class="info_content">' +
            '<h3>{{ project.title }}' +
            '<p>' +
            '<small><i class="fa fa-user fa-fw"></i> <a href="/profile/{{ project.owner.username }}">{{ project.owner.profile.artist_name }}</a> ' +
            '<i class="fa fa-gbp fa-fw"></i>{% if project.price == 0 %}No Payment{% else %}{{ project.price }}{% endif %}</small>' +
            '</p>' +
            '</h3>' +
            '<p>{{ project.description|truncatewords:20 }}</p>' +
            //'<p><button class="btn btn-default btn-sm" onclick="wavesurfer{{ forloop.counter0 }}.playPause();"><i class="fa fa-play fa-fw"></i></button></button><div id="wave{{ forloop.counter0 }}"></div></p>' +
            '<div class="audiojs"><audio src="{{ project.audio_file.url }}" controls preload="none" /></div><br />' +
            '<CENTER><a href="/listing/{{ project.id }}"><button class="btn btn-default btn-sm"><i class="fa fa-search fa-fw"></i> More Info</button></a></CENTER>' +
            '</div>'],
            {% endfor %}
        ];

        // Display multiple markers on a map
        var infoWindow = new google.maps.InfoWindow(), marker, i;

        // Loop through array of markers & place each one on the map
        for( i = 0; i < markers.length; i++ ) {
            var position = new google.maps.LatLng(markers[i][1], markers[i][2]);

            marker = new google.maps.Marker({
                position: position,
                map: map,
                title: markers[i][0]
            });

            // Allow each marker to have an info window
            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infoWindow.setContent(infoWindowContent[i][0]);
                    infoWindow.open(map, marker);
                }
            })(marker, i));
        }

      }
      google.maps.event.addDomListener(window, 'load', initialize);

      window.onresize = function(event) {
        initialize()
      };

    </script>
{%  endblock %}

{% block content %}

    <div class="blank_page_content">
        <h1>Browse Projects
        <p><small>Get involved in projects near you</small></p></h1>

        <!-- GOOGLE MAP API --><div id="map-canvas"></div>

    </div>

{% endblock %}

{% block audio_init %}

    <!-- Create audio player for each project -->
    <script>
        var wavesurfer = new Array() ;
        {% for project in project_list %}
        var wavesurfer{{ forloop.counter0 }} = Object.create(WaveSurfer);
        wavesurfer{{ forloop.counter0 }}.init({
            container: document.querySelector('#wave{{ forloop.counter0 }}'),
            waveColor: 'pink',
            progressColor: 'violet'
        });
        wavesurfer{{ forloop.counter0 }}.load('{{ project.audio_file.url }}');
        {% endfor %}
    </script>
{% endblock %}
